<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HFT Admin Dashboard</title>
  <style>
    :root {
      --bg: #0f1117;
      --bg-card: #1a1d27;
      --bg-card-hover: #222632;
      --border: #2a2e3a;
      --text: #e4e6eb;
      --text-secondary: #9ca3af;
      --text-tertiary: #6b7280;
      --primary: #6366f1;
      --primary-hover: #818cf8;
      --green: #22c55e;
      --green-bg: rgba(34,197,94,0.12);
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.12);
      --yellow: #eab308;
      --yellow-bg: rgba(234,179,8,0.12);
      --blue: #3b82f6;
      --blue-bg: rgba(59,130,246,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: white;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 600;
    }

    .logo-text span {
      color: var(--text-secondary);
      font-weight: 400;
      font-size: 14px;
      margin-left: 8px;
    }

    .user-select-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-select-wrap label {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    select {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 32px 8px 12px;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      min-width: 220px;
    }

    select:hover { border-color: var(--primary); }
    select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }

    .engine-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      background: var(--bg);
      border: 1px solid var(--border);
    }

    .engine-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-secondary);
    }

    .empty-state h2 {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-state p { font-size: 14px; }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
      .header { padding: 12px 16px; }
      .container { padding: 16px; }
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .card-body { padding: 20px; }
    .card-body-flush { padding: 0; }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .stat-item {
      padding: 14px 16px;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
    }

    .stat-value.green { color: var(--green); }
    .stat-value.red { color: var(--red); }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }

    .detail-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-item:nth-child(odd) {
      border-right: 1px solid var(--border);
    }

    .detail-label {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    .detail-value {
      font-size: 14px;
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      padding: 10px 16px;
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      font-weight: 600;
    }

    tbody td {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    tbody tr:last-child td { border-bottom: none; }

    tbody tr:hover { background: var(--bg-card-hover); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-buy { background: var(--green-bg); color: var(--green); }
    .badge-sell { background: var(--red-bg); color: var(--red); }
    .badge-active { background: var(--green-bg); color: var(--green); }
    .badge-inactive { background: var(--bg); color: var(--text-tertiary); border: 1px solid var(--border); }
    .badge-executed { background: var(--green-bg); color: var(--green); }
    .badge-pending { background: var(--yellow-bg); color: var(--yellow); }
    .badge-cancelled { background: var(--bg); color: var(--text-tertiary); }
    .badge-failed { background: var(--red-bg); color: var(--red); }
    .badge-simulation { background: var(--blue-bg); color: var(--blue); }

    .mono { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; }

    .no-data {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-tertiary);
      font-size: 13px;
    }

    .strategy-card {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .strategy-card:last-child { border-bottom: none; }

    .strategy-info { flex: 1; min-width: 0; }

    .strategy-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .strategy-desc {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .strategy-params {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .param-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .summary-cards { grid-template-columns: repeat(2, 1fr); }
    }

    .summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 20px;
    }

    .summary-card .label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .summary-card .value {
      font-size: 24px;
      font-weight: 700;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-secondary);
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .full-width { grid-column: 1 / -1; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">HF</div>
        <div class="logo-text">
          Admin Dashboard
          <span>HFT Trading API</span>
        </div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div class="user-select-wrap">
        <label for="userSelect">Select User</label>
        <select id="userSelect" data-testid="select-user">
          <option value="">Select a user...</option>
        </select>
      </div>
      <div class="engine-badge" id="engineBadge" data-testid="badge-engine-status">
        <div class="engine-dot"></div>
        <span>Engine: Loading...</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="emptyState" class="empty-state">
      <h2>Select a user to view their dashboard</h2>
      <p>Choose a user from the dropdown above to see their details, trades, and available strategies.</p>
    </div>

    <div id="dashboard" style="display:none">
      <div class="summary-cards" id="summaryCards" data-testid="summary-cards">
        <div class="summary-card">
          <div class="label">Capital</div>
          <div class="value" id="sumCapital" data-testid="text-capital">--</div>
        </div>
        <div class="summary-card">
          <div class="label">Total Trades</div>
          <div class="value" id="sumTrades" data-testid="text-total-trades">0</div>
        </div>
        <div class="summary-card">
          <div class="label">Active Strategies</div>
          <div class="value" id="sumStrategies" data-testid="text-active-strategies">0</div>
        </div>
        <div class="summary-card">
          <div class="label">Engine Mode</div>
          <div class="value" id="sumMode" data-testid="text-engine-mode">--</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card" data-testid="card-user-details">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
              User Details
            </div>
          </div>
          <div class="card-body-flush">
            <div class="detail-grid" id="userDetails" data-testid="grid-user-details">
            </div>
          </div>
        </div>

        <div class="card" data-testid="card-engine-overview">
          <div class="card-header">
            <div class="card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
              Engine Overview
            </div>
          </div>
          <div class="card-body">
            <div class="stat-row" id="engineStats" data-testid="grid-engine-stats">
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:20px" data-testid="card-trades">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Trades
          </div>
          <span id="tradeCount" style="font-size:12px;color:var(--text-tertiary)" data-testid="text-trade-count"></span>
        </div>
        <div class="card-body-flush">
          <div style="overflow-x:auto">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Strategy</th>
                  <th>P&L</th>
                  <th>Exit Price</th>
                  <th>Exit Reason</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="tradesBody" data-testid="table-trades-body">
              </tbody>
            </table>
          </div>
          <div id="noTrades" class="no-data" style="display:none" data-testid="text-no-trades">
            No trades found for this user.
          </div>
        </div>
      </div>

      <div class="card" data-testid="card-strategies">
        <div class="card-header">
          <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
            Available Strategies
          </div>
          <span id="strategyCount" style="font-size:12px;color:var(--text-tertiary)" data-testid="text-strategy-count"></span>
        </div>
        <div class="card-body-flush" id="strategiesBody" data-testid="list-strategies">
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '';

    async function fetchJSON(url) {
      const res = await fetch(API + url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadUsers() {
      try {
        const users = await fetchJSON('/api/users');
        const sel = document.getElementById('userSelect');
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.first_name || ''} ${u.last_name || ''}`.trim() || u.email || u.id;
          sel.appendChild(opt);
        });
        if (users.length === 1) {
          sel.value = users[0].id;
          loadDashboard(users[0].id);
        }
      } catch (e) {
        console.error('Failed to load users:', e);
      }
    }

    async function loadEngineStatus() {
      try {
        const status = await fetchJSON('/api/engine/status');
        const badge = document.getElementById('engineBadge');
        const dot = badge.querySelector('.engine-dot');
        const text = badge.querySelector('span');
        if (status.is_running) {
          dot.style.background = 'var(--green)';
          text.textContent = `Engine: ${status.mode || 'Running'}`;
        } else {
          dot.style.background = 'var(--red)';
          dot.style.animation = 'none';
          text.textContent = 'Engine: Stopped';
        }
        return status;
      } catch (e) {
        console.error('Failed to load engine status:', e);
        return null;
      }
    }

    async function loadDashboard(userId) {
      if (!userId) {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      try {
        const [user, trades, strategies, engineStatus] = await Promise.all([
          fetchJSON(`/api/users/${userId}`),
          fetchJSON(`/api/trades?user_id=${userId}`).catch(() => []),
          fetchJSON('/api/strategies').catch(() => []),
          loadEngineStatus(),
        ]);

        renderUserDetails(user);
        renderSummary(user, trades, strategies, engineStatus);
        renderEngineStats(engineStatus);
        renderTrades(trades);
        renderStrategies(strategies);
      } catch (e) {
        console.error('Failed to load dashboard:', e);
        document.getElementById('dashboard').innerHTML =
          '<div class="no-data" style="padding:60px">Failed to load user data. Please try again.</div>';
      }
    }

    function renderSummary(user, trades, strategies, engine) {
      document.getElementById('sumCapital').textContent =
        formatCurrency(user.initial_capital || 100000);
      document.getElementById('sumTrades').textContent = trades.length;
      document.getElementById('sumStrategies').textContent =
        strategies.filter(s => s.is_active).length + ' / ' + strategies.length;
      document.getElementById('sumMode').innerHTML =
        `<span class="badge badge-simulation">${engine?.mode || 'N/A'}</span>`;
    }

    function renderUserDetails(user) {
      const grid = document.getElementById('userDetails');
      const items = [
        ['User ID', user.id],
        ['Email', user.email || 'Not set'],
        ['First Name', user.first_name || 'N/A'],
        ['Last Name', user.last_name || 'N/A'],
        ['Initial Capital', formatCurrency(user.initial_capital || 100000)],
        ['Groww API Key', user.groww_api_key ? maskKey(user.groww_api_key) : 'Not configured'],
        ['Created', formatDate(user.created_at)],
        ['Last Updated', formatDate(user.updated_at)],
      ];
      grid.innerHTML = items.map(([label, value]) =>
        `<div class="detail-item">
          <span class="detail-label">${label}</span>
          <span class="detail-value">${value}</span>
        </div>`
      ).join('');
    }

    function renderEngineStats(engine) {
      if (!engine) return;
      const stats = document.getElementById('engineStats');
      const items = [
        ['Scan Count', engine.scan_count || 0],
        ['Open Positions', engine.open_positions || 0],
        ['Daily P&L', formatCurrency(engine.daily_pnl || 0), engine.daily_pnl >= 0 ? 'green' : 'red'],
        ['Symbols', engine.symbols?.length || 0],
      ];
      stats.innerHTML = items.map(([label, value, cls]) =>
        `<div class="stat-item">
          <div class="stat-label">${label}</div>
          <div class="stat-value ${cls || ''}">${value}</div>
        </div>`
      ).join('');
    }

    function renderTrades(trades) {
      const tbody = document.getElementById('tradesBody');
      const noData = document.getElementById('noTrades');
      const count = document.getElementById('tradeCount');

      count.textContent = `${trades.length} trade${trades.length !== 1 ? 's' : ''}`;

      if (trades.length === 0) {
        tbody.innerHTML = '';
        noData.style.display = 'block';
        return;
      }
      noData.style.display = 'none';
      tbody.innerHTML = trades.map(t => {
        const sideBadge = t.side === 'BUY'
          ? '<span class="badge badge-buy">BUY</span>'
          : '<span class="badge badge-sell">SELL</span>';
        const statusBadge = `<span class="badge badge-${(t.status||'').toLowerCase()}">${t.status}</span>`;
        const pnl = t.pnl ? parseFloat(t.pnl) : null;
        const pnlText = pnl !== null
          ? `<span style="color:${pnl >= 0 ? 'var(--green)' : 'var(--red)'}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</span>`
          : '--';
        return `<tr data-testid="row-trade-${t.id}">
          <td class="mono">${t.id}</td>
          <td style="font-weight:600">${t.symbol}</td>
          <td>${sideBadge}</td>
          <td class="mono">${t.quantity}</td>
          <td class="mono">${parseFloat(t.price).toFixed(2)}</td>
          <td>${statusBadge}</td>
          <td>${t.strategy_id || '--'}</td>
          <td class="mono">${pnlText}</td>
          <td class="mono">${t.exit_price ? parseFloat(t.exit_price).toFixed(2) : '--'}</td>
          <td>${t.exit_reason || '--'}</td>
          <td style="color:var(--text-secondary)">${formatDate(t.timestamp)}</td>
        </tr>`;
      }).join('');
    }

    function renderStrategies(strategies) {
      const body = document.getElementById('strategiesBody');
      const count = document.getElementById('strategyCount');
      const active = strategies.filter(s => s.is_active).length;
      count.textContent = `${active} active / ${strategies.length} total`;

      body.innerHTML = strategies.map(s => {
        const badge = s.is_active
          ? '<span class="badge badge-active">Active</span>'
          : '<span class="badge badge-inactive">Inactive</span>';
        const params = s.parameters
          ? Object.entries(s.parameters).map(([k,v]) =>
              `<span class="param-tag">${k}: ${v}</span>`
            ).join('')
          : '';
        return `<div class="strategy-card" data-testid="strategy-item-${s.id}">
          <div class="strategy-info">
            <div class="strategy-name">${s.name}</div>
            <div class="strategy-desc">${s.description || ''}</div>
            ${params ? `<div class="strategy-params">${params}</div>` : ''}
          </div>
          ${badge}
        </div>`;
      }).join('');
    }

    function formatCurrency(val) {
      return new Intl.NumberFormat('en-IN', {
        style: 'currency', currency: 'INR', maximumFractionDigits: 0
      }).format(val);
    }

    function formatDate(dt) {
      if (!dt) return 'N/A';
      const d = new Date(dt);
      return d.toLocaleDateString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function maskKey(key) {
      if (key.length <= 8) return '****';
      return key.slice(0, 4) + '****' + key.slice(-4);
    }

    document.getElementById('userSelect').addEventListener('change', e => {
      loadDashboard(e.target.value);
    });

    loadUsers();
    loadEngineStatus();
    setInterval(loadEngineStatus, 30000);
  </script>
</body>
</html>
